# Plan

## Objective
- このプロジェクトが「AIエージェントによる基本的な開発」を実行するための要件を満たしているかを評価し、どのプロジェクトにも適用しやすい汎用運用として不足点と改善優先度を提示する。

## Scope
- In:
  - 運用ガイド: `AGENTS.md`, `docs/agent/overrides.md`, `docs/PROJECT_CONTEXT.md`, `docs/adr/*`
  - 実行基盤: `.codex/templates/*`, `.codex/runs/*`, `.codex/rules/*`, `scripts/codex-safe.ps1`
  - 補助方針: `docs/agent/*.md`, `docs/plans/TEMPLATE.md`
- Out:
  - 個別アプリ機能の実装品質評価
  - CI基盤そのものの新規実装

## Assumptions
- 「基本的な開発要件」は、計画管理・タスク実行・証跡・品質ゲート・安全制約・拡張性の6観点で判定する。
- 監査結果は現時点のリポジトリ状態に基づく。

## Hypotheses
- H1: 本リポジトリは、単一エージェントの基本開発運用に必要な必須要件を概ね満たしている。
- H2: 「どのプロジェクトにも対応できる汎用性」については、導入容易性と最小要件の明文化に改善余地がある。

## Research Plan
- Round 1 Query:
  - AIエージェント開発運用の一般的ベースライン（計画・検証・安全・ログ）を公開ガイドから収集する。
- Round 2 Query:
  - Round 1で曖昧だった論点（汎用性、ロール分離、安全ガード）を補強する根拠を追加確認する。
- Exit Criteria:
  - 主要仮説ごとに支持/反証の根拠がある。
  - 判定結果を「満たしている点」「不足点」「優先度付き改善」に分解できる。
  - 未解決論点に次アクションがある。

## Approach
- 監査基準を定義する（6観点）。
- Web調査を2ラウンド実施し、汎用要件の外部根拠を確保する。
- リポジトリ内の実装・文書を根拠付きで突合する。
- 判定結果をギャップ分析として整理し、改善提案を優先度付きで提示する。
- 標準フロー: `PLAN -> Web検索(不足知識) -> TASKS -> 実行 -> REPORT`

## Definition of Done
- 監査観点ごとに「適合/部分適合/未適合」を判定できる。
- 根拠ファイル/コマンド結果を提示できる。
- `docs/PROJECT_CONTEXT.md` に今回の運用知見を追記できる。
- ユーザー向けに、進捗・次アクション・証跡を含む報告を提示できる。

## Risks / Unknowns
- 「汎用的」の定義が広いため、評価軸が過不足になるリスク。
- 既存ドキュメントが運用を想定していても、実行検証が不足する可能性。
- 対策: 外部ベースラインとの照合と、実行可能な証跡（コマンド/ファイル）を優先する。

## Thinking Log
- 2026-02-27 11:05: 依頼は「汎用的なAIエージェント開発要件の適合監査」。まず評価軸を固定し、外部ベースラインとの照合後にリポジトリ適合性を判定する。
- 2026-02-27 11:05: AGENTS運用に従い、run作成・PLAN/TASKS/REPORT更新を先に完了してから監査実行へ進む。
- 2026-02-27 11:06: Round 1/2 調査により、評価軸に「OWASP由来のLLMリスク」と「SSDF由来の品質ゲート」を追加する判断を確定。
- 2026-02-27 11:07: シェル展開ミスで空ファイルが混入。Discoveredタスクとして除去し、監査対象を汚染しない方針を明示。
- 2026-02-27 11:10: 総合判定は「基本要件は満たすが、汎用性は部分適合」。主因はテンプレート整合と環境依存（PowerShell前提）。
- 2026-02-27 11:15: 追加依頼として、部分適合解消の実装計画を作成する。AGENTS §9 に従い `docs/plans/` にJST日付ファイルで計画書を新規作成する。
- 2026-02-27 11:29: 計画レビューの懸念は「承認ゲートの曖昧さ」「検証の具体性」「再評価条件の計測性」。順に修正し、再レビューで懸念0を目標とする。
- 2026-02-27 11:29: 修正後は前提条件・承認ゲート・具体コマンド・再評価判定マトリクスを追加し、実装着手時の曖昧さを解消した。
- 2026-02-27 11:58: ユーザーの実装指示を L2/L3 変更の承認として扱い、P0->P1->P2 を順次実装する。
- 2026-02-27 12:00: bash wrapper と verify を追加し、PowerShell依存の部分を補完。PowerShell側に codex が無い環境は verify 上で SKIP として可観測化する。
- 2026-02-27 12:06: 実装レビューで `scripts/codex-safe.sh` の失敗時ログ欠落（`codex_exec_exit` 未記録）を確認。`set -e` の影響を回避する修正が必要。
- 2026-02-27 12:08: codex実行部分を `set +e` でラップし、失敗時も終了コード記録を保証。テストに失敗系ケースを追加して再発防止した。
